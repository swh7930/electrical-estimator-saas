{% extends "admin/base.html" %} {% block title %}Edit Assembly{% endblock %} {%
block admin_content %}
<div class="assemblies-edit-page" data-open-flag="{{ open_flag or '' }}">
  <div class="row topbar">
    <div>
      <div class="d-flex align-items-center gap-3 mb-1">
        <a
          href="{{ url_for('admin.list_assemblies') }}"
          class="link-secondary text-decoration-none"
        >
          &larr; Back to Assemblies
        </a>
        <h1 class="page-title m-0">Edit Assembly</h1>
      </div>
      <span class="text-muted">#{{ assembly.id }} — {{ assembly.name }}</span>
      {% if assembly.category %}<span class="text-muted"
        >• {{ assembly.category }}</span
      >{% endif %} {% if assembly.subcategory %}<span class="text-muted"
        >/ {{ assembly.subcategory }}</span
      >{% endif %} {% if assembly.is_featured %}<span class="text-muted"
        >• Featured</span
      >{% endif %}
    </div>
    <div class="row">
      <button
        type="button"
        class="btn btn-primary w-100 mb-2"
        data-open="dlgAddComp"
      >
        Add Component
      </button>
      {% if show_all %}
      <a
        class="btn btn-outline-secondary w-100 mb-2"
        href="{{ url_for('admin.edit_assembly', assembly_id=assembly.id) }}"
        >Hide inactive</a
      >
      {% else %}
      <a
        class="btn btn-outline-secondary w-100 mb-2"
        href="{{ url_for('admin.edit_assembly', assembly_id=assembly.id, show='all') }}"
        >Show inactive</a
      >
      {% endif %}
      <button
        type="button"
        class="btn btn-outline-danger w-100"
        data-open="dlgDeleteAsm"
      >
        Delete
      </button>
    </div>
  </div>

  <div class="panel">
    <h2 class="mb-2">Components</h2>
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Material</th>
            <th scope="col">Qty per</th>
            <th scope="col">Sort</th>
            <th scope="col">Active</th>
            <th scope="col">Created</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for comp in components %}
          <tr>
            <td>{{ comp.id }}</td>
            <td>
              {{ comp.material.item_description if comp.material else
              comp.material_id }}
            </td>
            <td>{{ "%.4f"|format(comp.qty_per_assembly) }}</td>
            <td>
              {{ comp.sort_order if comp.sort_order is not none else "" }}
            </td>
            <td>{{ "yes" if comp.is_active else "no" }}</td>
            <td>{{ comp.created_at }}</td>
            <td>
              {% if comp.is_active %}
              <form
                method="post"
                action="{{ url_for('admin.deactivate_component',
                                        assembly_id=assembly.id,
                                        component_id=comp.id,
                                        show='all' if show_all else '') }}"
                class="d-inline"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <button class="btn btn-outline-secondary btn-sm" type="submit">
                  Deactivate
                </button>
              </form>
              {% else %}
              <form
                method="post"
                action="{{ url_for('admin.activate_component',
                                        assembly_id=assembly.id,
                                        component_id=comp.id,
                                        show='all' if show_all else '') }}"
                class="d-inline"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <button class="btn btn-outline-secondary btn-sm" type="submit">
                  Activate
                </button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" class="text-muted">No components yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add Component Dialog -->
  <dialog id="dlgAddComp">
    <form
      method="post"
      action="{{ url_for('admin.add_component', assembly_id=assembly.id) }}"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <header><strong>Add Component</strong></header>
      <main class="row-gap">
        <div class="grid-3">
          <div>
            <label for="material_id">Material</label>
            <select id="material_id" name="material_id" required>
              <option value="">-- select material --</option>
              {% for mid, desc in materials %}
              <option value="{{ mid }}">{{ desc }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="qty_per_assembly">Qty per assembly</label>
            <input
              id="qty_per_assembly"
              name="qty_per_assembly"
              type="number"
              step="0.0001"
              min="0.0001"
              required
            />
          </div>
          <div>
            <label for="sort_order">Sort order (optional)</label>
            <input id="sort_order" name="sort_order" type="number" step="1" />
          </div>
        </div>
      </main>
      <footer>
        <button class="btn ghost" data-close="dlgAddComp" type="button">
          Cancel
        </button>
        <button class="btn primary" type="submit">Add</button>
      </footer>
    </form>
  </dialog>

  <!-- Delete Assembly Dialog -->
  <dialog id="dlgDeleteAsm">
    <form
      method="post"
      action="{{ url_for('admin.delete_assembly', assembly_id=assembly.id) }}"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <header><strong>Delete Assembly</strong></header>
      <main class="row-gap">
        <p>
          <strong>Are you sure?</strong> This will permanently delete the
          assembly <em>{{ assembly.name }}</em> and all of its components. This
          cannot be undone.
        </p>
      </main>
      <footer>
        <button class="btn" data-close="dlgDeleteAsm" type="button">
          Cancel
        </button>
        <button class="btn primary btn-delete" type="submit">Delete</button>
      </footer>
    </form>
  </dialog>
</div>
{% endblock %} 

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/admin.assemblies_edit.js') }}"></script>
{% endblock %}
