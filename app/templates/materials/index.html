{% extends "base.html" %}
{% block title %}Materials · Electrical Estimator{%endblock %}
{% block container_class %}container-xxl{% endblock %}

{% block head_extra %}
  {{ super() }}
  <meta name="x-can-write" content="{{ '1' if can_write else '0' }}">
{% endblock %}

{% block content %}
<div id="materials-grid" class="row g-4">
  
  <!-- Header -->
  <div class="col-12">
    <header class="text-center border-bottom py-3 mb-3">
      {% if can_write %}
        <form method="post"
              action="{{ url_for('libraries.import_materials_starter_pack') }}"
              class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="rt" value="{{ (request.args.get('rt') or '') }}">
          <button id="importMaterialsStarterPack"
                  type="submit"
                  class="btn btn-sm btn-outline-primary">
            Import Starter Pack
          </button>
        </form>
      {% endif %}
      <div>
        <h1 class="h3 mb-1">Material List</h1>
        <div class="text-muted">
          Browse, add, and edit materials. Inline “Add” bar is at the top.
        </div>
      </div>
    </header>
  
    {% if back_label %}
      <div class="mb-2">
        <a href="{{ back_href or '#' }}"
          id="materialsBackLink"
          class="btn btn-link p-0"
          data-action="lib-back"
          data-rt="{{ rt }}"
          data-href="{{ back_href or '' }}">
          &larr; {{ back_label }}
        </a>
      </div>
    {% endif %}

  

    <!-- Inline Add Bar -->
    <div class="col-12">
      <form class="card p-3">
        <div class="row g-3 align-items-end">
          <!-- Material Type (Category) -->
          <div class="col-12 col-lg-3">
            <label class="form-label" for="materialType"
              >Category <span class="text-danger">*</span></label
            >
            <select
              id="materialType"
              name="material_type"
              class="form-select"
              required
              aria-required="true"
            >
              <option value="">Select…</option>
              {% if mat_types %}
                {% for t in mat_types %}
                  <option value="{{ t }}" {% if type_filter and type_filter == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              {% endif %}
              <option value="__new__">+ New category…</option>
            </select>
          </div>

          <!-- Description -->
          <div class="col-12 col-lg-5">
            <label class="form-label" for="mat_desc"
              >Description <span class="text-danger">*</span></label
            >
            <input
              id="mat_desc"
              name="item_description"
              type="text"
              class="form-control"
              placeholder='e.g., 3/4" EMT'
              required
              aria-required="true"
            />
          </div>

          <!-- SKU -->
          <div class="col-6 col-lg-2">
            <label class="form-label" for="mat_sku">SKU</label>
            <input
              id="mat_sku"
              name="sku"
              type="text"
              class="form-control"
              placeholder="SKU"
            />
          </div>

          <!-- Manufacturer -->
          <div class="col-6 col-lg-2">
            <label class="form-label" for="mat_mfr">Manufacturer</label>
            <input
              id="mat_mfr"
              name="manufacturer"
              type="text"
              class="form-control"
              placeholder="e.g., Crouse-Hinds"
            />
          </div>

          <!-- Vendor -->
          <div class="col-6 col-lg-2">
            <label class="form-label" for="mat_vendor">Vendor</label>
            <input
              id="mat_vendor"
              name="vendor"
              type="text"
              class="form-control"
              placeholder="e.g., Graybar"
            />
          </div>

          <!-- Price (numeric, 4dp) -->
          <div class="col-6 col-lg-2">
            <label class="form-label" for="mat_price"
              >Price <span class="text-danger">*</span></label
            >
            <input
              id="mat_price"
              name="price"
              type="number"
              step="0.01"
              class="form-control"
              placeholder="$0.00"
              required
              aria-required="true"
              inputmode="decimal"
            />
          </div>

          <!-- Labor Unit (hrs per unit, 4dp) -->
          <div class="col-6 col-lg-2">
            <label class="form-label" for="mat_labor"
              >Labor Unit (hrs) <span class="text-danger">*</span></label
            >
            <input
              id="mat_labor"
              name="labor_unit"
              type="number"
              step="0.01"
              min="0"
              class="form-control"
              placeholder="0.00"
              required
              aria-required="true"
              inputmode="decimal"
            />
          </div>

          <!-- Unit Quantity Size -->
          <div class="col-6 col-lg-2">
            <label class="form-label" for="mat_uqs"
              >Unit Qty Size <span class="text-danger">*</span></label
            >
            <select
              id="mat_uqs"
              name="unit_quantity_size"
              class="form-select"
              required
              aria-required="true"
            >
              <option value="">Select…</option>
              <option value="1">1</option>
              <option value="100">100</option>
              <option value="1000">1000</option>
            </select>
          </div>

          <!-- Material Cost Code -->
          <div class="col-12 col-lg-3">
            <label class="form-label" for="mat_mcc">Material Cost Code</label>
            <input
              id="mat_mcc"
              name="material_cost_code"
              type="text"
              class="form-control"
              placeholder="e.g., MAT-001"
            />
          </div>

          <!-- Material Cost Code Desc -->
          <div class="col-12 col-lg-3">
            <label class="form-label" for="mat_mccd">Mat Cost Code Desc</label>
            <input
              id="mat_mccd"
              name="mat_cost_code_desc"
              type="text"
              class="form-control"
              placeholder="Description of material code"
            />
          </div>

          <!-- Labor Cost Code -->
          <div class="col-12 col-lg-3">
            <label class="form-label" for="mat_lcc">Labor Cost Code</label>
            <input
              id="mat_lcc"
              name="labor_cost_code"
              type="text"
              class="form-control"
              placeholder="e.g., LAB-001"
            />
          </div>

          <!-- Labor Cost Code Desc -->
          <div class="col-12 col-lg-3">
            <label class="form-label" for="mat_lccd">Labor Cost Code Desc</label>
            <input
              id="mat_lccd"
              name="labor_cost_code_desc"
              type="text"
              class="form-control"
              placeholder="Description of labor code"
            />
          </div>

          <!-- Is Active -->
          <div class="col-12 col-lg-2">
            <div class="form-check mt-4">
              <input
                id="mat_active"
                name="is_active"
                class="form-check-input"
                type="checkbox"
                checked
              />
              <label class="form-check-label" for="mat_active">Active</label>
            </div>
          </div>

          <!-- Actions -->
          <div class="col-12 d-flex gap-2">
            <button type="button" class="btn btn-primary" id="materialsAddBtn">
              Add
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              id="materialsResetBtn"
              title="Clear the inline add form"
            >
              Reset
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="col-12">
      <div class="card">
        <div class="table-responsive table-scroll">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Category</th>
                <th>Description</th>
                <th>Unit</th>
                <th class="text-end">Cost ea</th>
                <th class="text-end">Unit Labor (hrs)</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if materials %} {% for m in materials %}
              <tr id="mat-{{ m.id }}">
                <!-- Keep column order to match your THEAD -->
                <td class="text-nowrap">{{ m.material_type or "" }}</td>
                <td>{{ m.item_description or "" }}</td>
                <td class="text-nowrap">
                  {# You don't store a text unit; show the unit rule value for now
                  #} {{ m.unit_quantity_size if m.unit_quantity_size is not none
                  else "" }}
                </td>
                <td class="text-end">
                  {% set p = m.price or 0 %} ${{ "{:,.2f}".format(p) }}
                </td>
                <td class="text-end">{{ "%.2f"|format(m.labor_unit or 0) }}</td>
                <td class="text-end">
                  <div class="btn-group">
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      data-action="edit-material"
                      data-material-id="{{ m.id }}"
                      data-type="{{ m.material_type or '' }}"
                      data-desc="{{ m.item_description or '' }}"
                      data-sku="{{ m.sku or '' }}"
                      data-mfr="{{ m.manufacturer or '' }}"
                      data-vendor="{{ m.vendor or '' }}"
                      data-price="{{ m.price or '' }}"
                      data-labor="{{ m.labor_unit or '' }}"
                      data-uqs="{{ m.unit_quantity_size or '' }}"
                      data-mcc="{{ m.material_cost_code or '' }}"
                      data-mccd="{{ m.mat_cost_code_desc or '' }}"
                      data-lcc="{{ m.labor_cost_code or '' }}"
                      data-lccd="{{ m.labor_cost_code_desc or '' }}"
                      data-active="{{ 1 if (m.is_active or False) else 0 }}"
                      title="Edit"
                    >
                      Edit
                    </button>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      data-action="delete-material"
                      data-material-id="{{ m.id }}"
                      title="Delete"
                    >
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %} {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  No materials found.
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Material Category Modal -->
<div class="modal fade" id="matNewCategoryModal" tabindex="-1" aria-labelledby="matNewCategoryTitle"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="matNewCategoryTitle">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label class="form-label" id="matNewCategoryLabel" for="matNewCategoryInput">Category name</label>
        <input type="text" class="form-control" id="matNewCategoryInput" autocomplete="off" placeholder="e.g., Conduit">
        <div id="matNewCategoryHelp" class="form-text">This will be added to the Category list.</div>
        <div id="matNewCategoryError" class="text-danger small mt-2 d-none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="matNewCategoryConfirmBtn">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- Modals (visual only) -->
<div class="modal fade" id="materialEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Material</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <!-- Category (locked / read-only) -->
        <div class="mb-3">
          <label class="form-label" for="edit_materialType">Category</label>
          <input type="text" class="form-control" id="edit_materialType" readonly>
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label" for="edit_desc">Description</label>
          <input type="text" class="form-control" id="edit_desc">
        </div>

        <!-- SKU / Manufacturer / Vendor -->
        <div class="row g-3 mb-3">
          <div class="col-4">
            <label class="form-label" for="edit_sku">SKU</label>
            <input type="text" class="form-control" id="edit_sku">
          </div>
          <div class="col-4">
            <label class="form-label" for="edit_mfr">Manufacturer</label>
            <input type="text" class="form-control" id="edit_mfr">
          </div>
          <div class="col-4">
            <label class="form-label" for="edit_vendor">Vendor</label>
            <input type="text" class="form-control" id="edit_vendor">
          </div>
        </div>

        <!-- Price / Labor / Unit Qty Size -->
        <div class="row g-3 mb-3">
          <div class="col-4">
            <label class="form-label" for="edit_price">Cost ea</label>
            <input type="number" step="0.01" class="form-control" id="edit_price">
          </div>
          <div class="col-4">
            <label class="form-label" for="edit_labor">Unit Labor (hrs)</label>
            <input type="number" step="0.01" class="form-control" id="edit_labor">
          </div>
          <div class="col-4">
            <label class="form-label" for="edit_uqs">Unit Qty Size</label>
            <select class="form-select" id="edit_uqs">
              <option value="">Select…</option>
              <option value="1">1</option>
              <option value="100">100</option>
              <option value="1000">1000</option>
            </select>
          </div>
        </div>

        <!-- Cost codes -->
        <div class="row g-3 mb-3">
          <div class="col-6">
            <label class="form-label" for="edit_mcc">Material Cost Code</label>
            <input type="text" class="form-control" id="edit_mcc">
          </div>
          <div class="col-6">
            <label class="form-label" for="edit_mccd">Mat Cost Code Desc</label>
            <input type="text" class="form-control" id="edit_mccd">
          </div>
          <div class="col-6">
            <label class="form-label" for="edit_lcc">Labor Cost Code</label>
            <input type="text" class="form-control" id="edit_lcc">
          </div>
          <div class="col-6">
            <label class="form-label" for="edit_lccd">Labor Cost Code Desc</label>
            <input type="text" class="form-control" id="edit_lccd">
          </div>
        </div>

        <!-- Active -->
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="edit_active">
          <label class="form-check-label" for="edit_active">Active</label>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="materialEditSaveBtn">Save changes</button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="confirmDeleteModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Material</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        This will remove the material. Visual-only stub.
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script src="{{ url_for('static', filename='js/materials_index.js') }}"></script>
{% endblock %}
